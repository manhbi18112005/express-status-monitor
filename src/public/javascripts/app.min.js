(()=>{let o={SCROLL_THROTTLE:100,CHART_HEIGHT_RATIO:1.5,STATUS_CODES_COLORS:["#75D701","#47b8e0","#ffc952","#E53A40"],COMMON_CLASSES:["bg-white","dark:bg-slate-800","shadow-lg","p-0","relative","rounded-lg","overflow-hidden","m-2"]},r=(Chart.defaults.set({font:{size:10},animation:{duration:500},elements:{line:{backgroundColor:"transparent",borderColor:"rgba(0,0,0,0.9)",borderWidth:2}}}),{throttle(e,a){let s;return function(...t){s||(e.apply(this,t),s=!0,setTimeout(()=>s=!1,a))}},createDefaultDataset(){return{label:"",data:[],borderColor:"rgb(75, 192, 192)",tension:.1,fill:!1,pointRadius:0}},formatTimestamp(t){return new Date(t).toLocaleString()}}),a={responsive:!0,animation:!1,interaction:{mode:"nearest"},scales:{x:{type:"time",display:!0,title:{display:!0,text:"Date"},ticks:{autoSkip:!1,maxRotation:0,major:{enabled:!0},font:t=>t.tick?.major?{weight:"bold"}:void 0}},y:{display:!0,title:{display:!0,text:"value"}}},plugins:{legend:{display:!0},tooltip:{enabled:!0},zoom:{pan:{enabled:!0,mode:"xy",modifierKey:"ctrl"},zoom:{mode:"xy",wheel:{enabled:!0},drag:{enabled:!0,backgroundColor:"rgba(225,225,225,0.5)"}}}}},n={cpu:{id:"cpu",keyName:"CPU Usage",value:"cpu"},mem:{id:"mem",keyName:"Memory Usage",value:"memory"},load:{id:"load",keyName:"Load Average",value:"load"},heap:{id:"heap",keyName:"Heap Usage",value:"heap"},eventLoop:{id:"eventLoop",keyName:"Event Loop",value:"loop"},responseTime:{id:"responseTime",keyName:"Response Time",value:"mean"},rps:{id:"rps",keyName:"Requests/Second",value:"count"},statusCodes:{id:"statusCodes",keyName:"Status Codes",datasets:4}};class t{constructor(t="container"){this.container=document.getElementById(t),this.charts=new Map,this.spans=[],this.defaultSpan=0,this.createChartContainers(),this.setupSocket(),this.initializeCharts(),this.setupEventListeners()}createChartContainers(){let a=document.createDocumentFragment();Object.values(n).forEach(t=>{var e=document.createElement("div");e.classList.add(...o.COMMON_CLASSES),Object.assign(e,{id:t.id+"Block",style:"width: auto; height: auto; transform: translate(0px, 0px)"}),e.dataset.x="0",e.dataset.y="0",e.innerHTML=this.createBlockHTML(t),a.appendChild(e)}),this.container.appendChild(a)}createBlockHTML({id:t,keyName:e}){return`
            <div class="titlebar bg-gray-50 dark:bg-slate-700 flex items-center justify-between p-3 cursor-move">
                <div class="window-controls flex gap-2 ml-2">
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="key-name font-medium text-lg">${e}</span>
                    <span class="value font-bold text-3xl" id="${t}Stat">--</span>
                </div>
                <div class="w-16"></div>
            </div>
            <div class="p-3">
                <div class="block-content centered-content">
                    <canvas class="responsive-canvas" id="${t}Chart"></canvas>
                </div>
            </div>`}setupDraggable(){Object.values(n).forEach(t=>{let e=document.getElementById(t.id+"Block"),a=e.querySelector(".titlebar"),s=!1,n,o,r,i,d=parseInt(e.dataset.x)||0,l=parseInt(e.dataset.y)||0;a.addEventListener("mousedown",t=>{r=t.clientX-d,i=t.clientY-l,t.target===a&&(s=!0)}),document.addEventListener("mousemove",t=>{s&&(t.preventDefault(),n=t.clientX-r,o=t.clientY-i,d=n,l=o,e.style.transform=`translate(${n}px, ${o}px)`)}),document.addEventListener("mouseup",()=>{s=!1,e.dataset.x=d,e.dataset.y=l})})}setupSocket(){this.socket=io(location.protocol+`//${location.hostname}:`+(port||location.port),{path:socketPath,transports:["websocket"]}),this.socket.on("esm_start",this.handleStart.bind(this)),this.socket.on("esm_stats",this.handleStats.bind(this))}createChart(t,e){e=new Chart(t,{type:"line",data:{labels:[],datasets:e},options:a});return t.height=t.width*o.CHART_HEIGHT_RATIO,e}initializeCharts(){for(var[t,e]of Object.entries(n)){var a=document.getElementById(t+"Chart"),s=Array(e.datasets||1).fill().map(()=>r.createDefaultDataset());"statusCodes"===t&&s.forEach((t,e)=>{t.borderColor=o.STATUS_CODES_COLORS[e]}),this.charts.set(t,{chart:this.createChart(a,s),stat:document.getElementById(t+"Stat"),config:e})}this.setupDraggable()}setupEventListeners(){let e=document.getElementById("con_con"),a=document.getElementById("header"),s=document.getElementById("topButton"),n=0;var t=r.throttle(()=>{var t=e.scrollTop;a.style.transform=`translateY(${t<=0||t<n?"0":"-100%"})`,s&&(s.classList.toggle("button-visible",200<t),s.classList.toggle("button-hidden",t<=200)),n=t},o.SCROLL_THROTTLE);e.addEventListener("scroll",t,{passive:!0}),s?.addEventListener("click",()=>{e.scrollTo({top:0,behavior:"smooth"})})}updateChart(t,e,a){var s,n,o=this.charts.get(t);o&&({chart:o,stat:s,config:n}=o,void 0!==(e=this.getValue(e,n.value)))&&(s&&(s.textContent=this.formatValue(e,t)),o.data.datasets[0].data.push(e),o.data.labels.push(a),this.trimChartData(o))}getValue(t,e){return e?e.split(".").reduce((t,e)=>t?.[e],t):t}formatValue(t,e){return{cpu:t=>t.toFixed(1)+"%",mem:t=>t.toFixed(1)+"MB",load:t=>t[0].toFixed(2),heap:t=>(t.used_heap_size/1024/1024).toFixed(1)+"MB",eventLoop:t=>t.loop?t.loop.sum:0,responseTime:t=>t.toFixed(2)+"ms",rps:t=>t.toFixed(2)}[e]?.(t)??t.toString()}trimChartData(t){var e=this.spans[this.defaultSpan]?.retention;e&&t.data.labels.length>e&&(t.data.datasets.forEach(t=>t.data.shift()),t.data.labels.shift())}handleStart(t){document.getElementById("currenttime").textContent=r.formatTimestamp(Date.now()),t[this.defaultSpan].responses.pop(),t[this.defaultSpan].os.pop(),this.updateAllCharts(t[this.defaultSpan]),this.updateSpanControls(t)}handleStats(t){t.retention===this.spans[this.defaultSpan]?.retention&&t.interval===this.spans[this.defaultSpan]?.interval&&(document.getElementById("currenttime").textContent=r.formatTimestamp(Date.now()),this.updateAllCharts(t))}updateAllCharts(e){let a=e.timestamp??Date.now();if(e.os&&["cpu","mem","load","heap","eventLoop"].forEach(t=>{this.updateChart(t,e.os,a)}),e.responses){["responseTime","rps"].forEach(t=>{this.updateChart(t,e.responses,a)});var s=this.charts.get("statusCodes").chart;for(let t=0;t<4;t++)s.data.datasets[t].data.push(e.responses[t+2]),s.data.datasets[t].label=t+2+"xx";s.data.labels.push(a),this.trimChartData(s)}for(var{chart:t}of this.charts.values())t.update()}updateSpanControls(t){var e=document.getElementById("span-controls");if(t.length!==this.spans.length){let s=document.createDocumentFragment();this.spans=t.map((t,e)=>{var a=document.createElement("button");return a.className="p-3 w-10 h-10 rounded-lg border border-gray-200 hover:border-gray-400 dark:border-gray-700 dark:hover:border-gray-500 dark:hover:bg-gray-700 transition-all duration-200 ease-in-out flex items-center justify-center font-bold",a.textContent=t.retention*t.interval/60+"M",a.id=e,a.onclick=t=>{document.querySelectorAll("#span-controls button").forEach(t=>t.classList.remove("active")),t.target.classList.add("active"),this.defaultSpan=parseInt(t.target.id,10),this.socket.emit("esm_change")},s.appendChild(a),{retention:t.retention,interval:t.interval}}),e.innerHTML="",e.appendChild(s),e.querySelector("button").classList.add("active")}}}document.addEventListener("DOMContentLoaded",()=>{new t})})();